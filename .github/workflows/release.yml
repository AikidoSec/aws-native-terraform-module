name: Release Module

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Validate Terraform
        run: |
          cd source
          terraform init -backend=false
          terraform validate

      - name: Generate Changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create module archive
        run: |
          # Create a clean archive of the module
          git archive --format=zip --output=aikido-aws-terraform-module-${{ steps.version.outputs.VERSION }}.zip ${{ github.ref_name }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## Aikido Security AWS Integration Terraform Module ${{ github.ref_name }}

            ### Usage

            ```hcl
            module "aikido_security" {
              source = "github.com/${{ github.repository }}//source?ref=${{ github.ref_name }}"

              external_id               = "your-aikido-external-id"
              organizational_unit_ids   = ["r-xxxx"]
              excluded_account_ids      = []
              enable_ecr_scanning       = true
              enable_ebs_scanning       = true
            }
            ```

            ### What's Changed
            ${{ steps.changelog.outputs.changelog }}

            ### Installation Methods

            **Option 1: GitHub Source (Recommended)**
            ```hcl
            module "aikido_security" {
              source = "github.com/${{ github.repository }}//source?ref=${{ github.ref_name }}"
              # ... configuration
            }
            ```

            **Option 2: Download Release Archive**
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aikido-aws-terraform-module-${{ steps.version.outputs.VERSION }}.zip
            unzip aikido-aws-terraform-module-${{ steps.version.outputs.VERSION }}.zip
            ```

            Then reference locally:
            ```hcl
            module "aikido_security" {
              source = "./aikido-aws-terraform-module-${{ steps.version.outputs.VERSION }}/source"
              # ... configuration
            }
            ```

            **Option 3: Direct Archive URL**
            ```hcl
            module "aikido_security" {
              source = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aikido-aws-terraform-module-${{ steps.version.outputs.VERSION }}.zip//source"
              # ... configuration
            }
            ```

            ### Documentation

            - [README](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/Readme.md)
            - [Examples](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/examples)
            - [Contributing](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CONTRIBUTING.md)
            - [Security Policy](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/SECURITY.md)
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
          files: |
            aikido-aws-terraform-module-${{ steps.version.outputs.VERSION }}.zip

  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Test module can be initialized
        run: |
          cd source
          terraform init -backend=false
          terraform validate

      - name: Test example can be initialized
        run: |
          cd examples
          terraform init -backend=false
          terraform validate

      - name: Post validation results
        if: always()
        run: |
          echo "Release validation completed for ${{ github.ref_name }}"
